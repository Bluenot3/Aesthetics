import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
import { 
  Activity, 
  Brain, 
  Clock, 
  Database, 
  Layers, 
  Sparkles, 
  Target, 
  User, 
  X,
  ChevronRight,
  Fingerprint,
  MoreHorizontal,
  Scan,
  Cpu,
  Search,
  Filter,
  Zap
} from 'lucide-react';

// --- Configuration ---
const PHYSICS = {
  friction: 0.95,       // Higher friction for a silkier, heavier feel
  springStrength: 0.05, // Lower strength for soft landing (no bounce)
  scrollSpeed: 0.003,   
  maxVelocity: 0.8      
};

// --- Mock Data Generation ---
const generateSpiralItems = () => {
  const types = ['agent', 'task', 'student', 'system'];
  const items = [];
  
  // Past (Memory)
  for (let i = -8; i < 0; i++) {
    items.push({
      id: `past-${Math.abs(i)}`,
      timeOffset: i,
      type: types[Math.floor(Math.random() * types.length)],
      title: `Memory Fragment 0x${Math.abs(i * 1024).toString(16)}`,
      timestamp: `${Math.abs(i)}h ago`,
      relevance: 0.3 + (Math.random() * 0.4),
      details: "Archived systemic interaction. Data integrity verified."
    });
  }

  // Present (Focus)
  items.push({
    id: 'now',
    timeOffset: 0,
    type: 'agent',
    title: 'Active Synthesis: Cortex AI',
    timestamp: 'Now',
    relevance: 1.0,
    details: "Currently processing logic streams for User Interface generation. 98% efficiency."
  });

  // Future (Potential)
  for (let i = 1; i <= 8; i++) {
    items.push({
      id: `future-${i}`,
      timeOffset: i,
      type: types[Math.floor(Math.random() * types.length)],
      title: `Predicted Event: ${['Sync', 'Review', 'Deploy', 'Audit'][i % 4]}`,
      timestamp: `In ${i * 45}m`,
      relevance: 0.8 - (i * 0.1),
      details: "Scheduled heuristic scan pending approval."
    });
  }

  return items;
};

// --- Visual Components ---

const AuroraBackground = ({ activeType }) => {
  // Map card types to gradient colors
  const gradients = {
    agent: 'from-cyan-900/20 via-blue-900/10',
    task: 'from-rose-900/20 via-orange-900/10',
    student: 'from-amber-900/20 via-yellow-900/10',
    system: 'from-emerald-900/20 via-teal-900/10',
    default: 'from-purple-900/20 via-indigo-900/10'
  };

  const activeGradient = gradients[activeType] || gradients.default;

  return (
    <div className="absolute inset-0 pointer-events-none transition-colors duration-1000 ease-in-out">
      <div className={`absolute top-[-20%] left-[-10%] w-[70vw] h-[70vw] bg-gradient-radial ${activeGradient} to-transparent rounded-full blur-[120px] transition-all duration-1000 opacity-60`} />
      <div className="absolute bottom-[-20%] right-[-10%] w-[60vw] h-[60vw] bg-gradient-radial from-slate-900/20 to-transparent rounded-full blur-[100px]" />
      <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-15 brightness-100 contrast-150 mix-blend-overlay"></div>
    </div>
  );
};

const ParticleField = ({ velocity }) => {
  const canvasRef = useRef(null);
  
  useEffect(() => {
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    let animationFrameId;
    
    // Handle High-DPI displays for crisp particles
    const resize = () => {
      const dpr = window.devicePixelRatio || 1;
      canvas.width = window.innerWidth * dpr;
      canvas.height = window.innerHeight * dpr;
      ctx.scale(dpr, dpr);
      canvas.style.width = `${window.innerWidth}px`;
      canvas.style.height = `${window.innerHeight}px`;
    };
    window.addEventListener('resize', resize);
    resize();

    const particles = Array.from({ length: 100 }, () => ({
      x: Math.random() * window.innerWidth,
      y: Math.random() * window.innerHeight,
      size: Math.random() * 1.5,
      speed: 0.2 + Math.random() * 0.5,
      alpha: 0.1 + Math.random() * 0.4
    }));

    const render = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear instead of fillRect for transparency
      
      // Smooth out visual velocity for particles so they don't jitter
      const warpFactor = 1 + (Math.abs(velocity) * 15);
      
      particles.forEach(p => {
        p.y += p.speed * warpFactor * (velocity < 0 ? -1 : 1);
        
        // Wrap around
        if (p.y > window.innerHeight) p.y = 0;
        if (p.y < 0) p.y = window.innerHeight;

        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(200, 220, 255, ${p.alpha})`;
        ctx.fill();
      });

      animationFrameId = requestAnimationFrame(render);
    };

    render();
    return () => {
      window.removeEventListener('resize', resize);
      cancelAnimationFrame(animationFrameId);
    };
  }, [velocity]);

  return <canvas ref={canvasRef} className="absolute inset-0 pointer-events-none opacity-50 mix-blend-screen" />;
};

const TiltCard = ({ children, isFocused, onClick }) => {
  const [transform, setTransform] = useState('');
  const [glow, setGlow] = useState('50% 50%');
  const cardRef = useRef(null);

  const handleMove = useCallback((e) => {
    if (!cardRef.current) return;
    const rect = cardRef.current.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    const xPct = (x / rect.width) - 0.5;
    const yPct = (y / rect.height) - 0.5;

    const rotateY = xPct * 15; 
    const rotateX = yPct * -15; 

    setTransform(`perspective(800px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.02, 1.02, 1.02)`);
    setGlow(`${(x / rect.width) * 100}% ${(y / rect.height) * 100}%`);
  }, []);

  const handleLeave = () => {
    setTransform('');
  };

  return (
    <div 
      ref={cardRef}
      className="w-full h-full transition-transform duration-200 ease-out preserve-3d cursor-pointer"
      style={{ transform }}
      onMouseMove={handleMove}
      onMouseLeave={handleLeave}
      onClick={onClick}
    >
      {children}
      {/* Interactive Gloss Reflection */}
      <div 
        className="absolute inset-0 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-500 rounded-2xl z-20"
        style={{
          background: `radial-gradient(circle at ${glow}, rgba(255,255,255,0.15), transparent 50%)`
        }}
      />
    </div>
  );
};

const CardContent = ({ item, isFocused, isFilteredOut }) => {
  const iconConfig = {
    agent: { icon: Brain, color: 'text-cyan-300', border: 'border-cyan-500/30', glow: 'shadow-cyan-500/20' },
    task: { icon: Target, color: 'text-rose-300', border: 'border-rose-500/30', glow: 'shadow-rose-500/20' },
    student: { icon: User, color: 'text-amber-300', border: 'border-amber-500/30', glow: 'shadow-amber-500/20' },
    system: { icon: Database, color: 'text-emerald-300', border: 'border-emerald-500/30', glow: 'shadow-emerald-500/20' }
  };
  
  const config = iconConfig[item.type];
  const Icon = config.icon;

  if (isFilteredOut) {
    return (
      <div className="w-full h-full rounded-2xl border border-white/5 bg-black/20 backdrop-blur-sm flex items-center justify-center opacity-30">
        <Icon className="w-6 h-6 text-white/20 grayscale" />
      </div>
    );
  }

  return (
    <div className={`
      relative w-full h-full rounded-2xl border overflow-hidden group transition-all duration-300
      ${isFocused 
        ? `bg-white/10 ${config.border} shadow-[0_0_30px_rgba(0,0,0,0.3)]` 
        : 'bg-[#121216]/60 border-white/10 hover:bg-[#1a1a20]/80 hover:border-white/20'
      }
    `}>
      {/* Inner Noise Texture for matte finish */}
      <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-10 mix-blend-overlay pointer-events-none" />

      {/* Active Scanline */}
      {isFocused && (
        <div className="absolute inset-0 pointer-events-none z-0 overflow-hidden rounded-2xl">
          <div className="absolute top-0 left-0 w-full h-[30%] bg-gradient-to-b from-transparent via-white/5 to-transparent animate-[scan_3s_ease-in-out_infinite]" />
        </div>
      )}
      
      <div className="h-full flex flex-col justify-between p-6 relative z-10">
        <div className="flex items-start justify-between">
          <div className="flex items-center space-x-4">
            <div className={`p-3 rounded-xl bg-white/5 border border-white/5 ${isFocused ? config.glow : ''}`}>
              <Icon className={`w-6 h-6 ${config.color}`} />
            </div>
            <div>
              <div className="text-[10px] uppercase tracking-[0.2em] text-white/40 font-mono mb-1">
                {item.timestamp}
              </div>
              <div className="text-lg font-medium text-white/90 tracking-wide leading-tight line-clamp-1">
                {item.title}
              </div>
            </div>
          </div>
          {isFocused && <Activity className="w-5 h-5 text-white/30 animate-pulse" />}
        </div>

        <div className="space-y-4">
           <div className="h-[1px] w-full bg-gradient-to-r from-transparent via-white/10 to-transparent" />
           <div className="flex justify-between items-center">
              <div className="flex space-x-2">
                 {[1,2,3,4,5].map(i => (
                   <div key={i} className={`w-1.5 h-1.5 rounded-full ${i <= item.relevance * 5 ? config.color.replace('text', 'bg') : 'bg-white/10'}`} />
                 ))}
              </div>
              <span className="text-[10px] font-mono text-white/30 tracking-widest">ID: {item.id.toUpperCase()}</span>
           </div>
        </div>
      </div>
    </div>
  );
};

// --- Main Application ---

const MemorySpiral = () => {
  const [items] = useState(generateSpiralItems);
  const [activeItem, setActiveItem] = useState(null);
  const [filter, setFilter] = useState('all');
  
  // Physics State
  const state = useRef({
    scroll: 0,        // Current visual position
    target: 0,        // Where we want to be (integer for snapping)
    velocity: 0,      // Current speed
    isDragging: false,
    lastY: 0
  });
  
  // React State for render updates
  const [visualScroll, setVisualScroll] = useState(0); 
  const [velocityDisplay, setVelocityDisplay] = useState(0);

  // --- Physics Engine ---
  useEffect(() => {
    let frameId;

    const loop = () => {
      const s = state.current;

      // 1. Apply Friction to Velocity
      s.velocity *= PHYSICS.friction;

      // 2. Snap Force (Critically Damped to prevent oscillation)
      if (!s.isDragging && Math.abs(s.velocity) < 0.05) {
        const snapTarget = Math.round(s.scroll);
        const dist = snapTarget - s.scroll;
        
        // Apply a gentle force towards center
        s.velocity += dist * PHYSICS.springStrength;
        
        // Apply EXTRA friction during the snap phase to kill the "back and forth" bounce
        // This acts as a damper, effectively stopping overshoot
        s.velocity *= 0.85; 
      }

      // 3. Update Position
      s.scroll += s.velocity;

      // 4. Soft Boundaries (Rubber banding)
      const min = -6; // Future limit
      const max = 8;  // Past limit
      if (s.scroll < min) {
        s.scroll = min + (s.scroll - min) * 0.1;
        s.velocity = 0;
      } else if (s.scroll > max) {
        s.scroll = max + (s.scroll - max) * 0.1;
        s.velocity = 0;
      }

      // 5. Update React State (Visuals)
      // Only update if changed significantly to save reacts
      if (Math.abs(s.velocity) > 0.001 || Math.abs(s.scroll - Math.round(s.scroll)) > 0.001) {
        setVisualScroll(s.scroll);
        setVelocityDisplay(s.velocity);
      } else {
        // Snap finish
        if (Math.abs(s.scroll - Math.round(s.scroll)) < 0.001) {
           s.scroll = Math.round(s.scroll);
           setVisualScroll(s.scroll);
        }
      }

      frameId = requestAnimationFrame(loop);
    };

    loop();
    return () => cancelAnimationFrame(frameId);
  }, []);

  // --- Interaction Handlers ---
  
  const handleWheel = (e) => {
    if (activeItem) return;
    // Add to velocity directly for momentum feel
    state.current.velocity += e.deltaY * 0.0005;
    // Cap velocity
    state.current.velocity = Math.max(Math.min(state.current.velocity, PHYSICS.maxVelocity), -PHYSICS.maxVelocity);
  };

  const handleTouchStart = (e) => {
    state.current.isDragging = true;
    state.current.lastY = e.touches[0].clientY;
    state.current.velocity = 0; // Stop current momentum on grab
  };

  const handleTouchMove = (e) => {
    if (activeItem) return;
    const delta = state.current.lastY - e.touches[0].clientY;
    state.current.lastY = e.touches[0].clientY;
    state.current.scroll += delta * 0.01; // Direct movement
    state.current.velocity = delta * 0.01; // store velocity for release throw
  };

  const handleTouchEnd = () => {
    state.current.isDragging = false;
  };

  // --- 3D Projection Logic ---
  const getCardStyle = (index, scroll, velocity) => {
    // Relative position in timeline
    const pos = index + scroll;
    
    // Config
    const radius = 260; // Larger radius for more cinematic feel
    const twist = 0.55; // Radians per unit
    const spacing = 160; 
    
    // Stretch spacing based on velocity (Warp effect)
    const dynamicSpacing = spacing + (Math.abs(velocity) * 200);

    const theta = pos * twist;
    const y = pos * dynamicSpacing;
    const x = Math.cos(theta) * radius;
    const z = Math.sin(theta) * (radius * 0.85) - Math.abs(pos) * 50;

    // Rotation: look at center but twist with spiral
    const rotateY = -theta * (180 / Math.PI) + 15;
    
    // Visibility calculations
    const dist = Math.abs(pos);
    const opacity = Math.max(0, 1 - Math.pow(dist * 0.22, 2)); // Quadratic falloff for crisper center
    const scale = Math.max(0, 1 - dist * 0.1);
    
    // Do not render if too far
    const display = opacity < 0.01 ? 'none' : 'block';

    return {
      transform: `translate3d(${x}px, ${y}px, ${z}px) rotateY(${rotateY}deg) scale(${scale})`,
      opacity,
      zIndex: 100 - Math.floor(dist * 10),
      filter: `blur(${Math.max(0, dist * 6 - 1)}px)`, // Delay blur slightly so center is razor sharp
      display
    };
  };

  // Determine current focus item for ambiance
  const focusedIndex = -Math.round(visualScroll);
  const focusedItem = items.find(i => -i.timeOffset === focusedIndex);
  const currentType = focusedItem ? focusedItem.type : 'default';

  return (
    <div 
      className="relative w-full h-screen bg-[#050508] text-white overflow-hidden font-sans select-none"
      onWheel={handleWheel}
      onTouchStart={handleTouchStart}
      onTouchMove={handleTouchMove}
      onTouchEnd={handleTouchEnd}
    >
      <style>{`
        @keyframes scan {
          0% { transform: translateY(-100%); }
          100% { transform: translateY(500%); }
        }
        .preserve-3d { transform-style: preserve-3d; }
      `}</style>

      {/* Backgrounds */}
      <AuroraBackground activeType={currentType} />
      <ParticleField velocity={velocityDisplay} />

      {/* --- HUD: Header --- */}
      <div className="absolute top-0 left-0 w-full p-8 flex justify-between items-start z-40 pointer-events-none">
        <div className="flex flex-col">
          <div className="flex items-center space-x-3">
             <Layers className="w-6 h-6 text-white/80" />
             <h1 className="text-2xl font-light tracking-[0.2em] uppercase text-white/90">Helix OS</h1>
          </div>
          <div className="flex items-center space-x-2 mt-2 ml-1">
             <div className={`w-1.5 h-1.5 rounded-full transition-colors duration-300 ${Math.abs(velocityDisplay) > 0.2 ? 'bg-rose-500 shadow-[0_0_10px_#f43f5e]' : 'bg-emerald-500 shadow-[0_0_10px_#10b981]'}`} />
             <span className="text-[10px] font-mono text-white/40 tracking-wider">
               PHYSICS ENGINE: ACTIVE // VEL: {Math.abs(velocityDisplay * 100).toFixed(0)}
             </span>
          </div>
        </div>

        {/* Filter Controls */}
        <div className="pointer-events-auto flex items-center bg-black/20 backdrop-blur-xl rounded-full p-1 border border-white/10">
           {['all', 'agent', 'task', 'student'].map(f => (
             <button 
               key={f}
               onClick={() => setFilter(f)}
               className={`
                 px-4 py-2 rounded-full text-xs font-medium transition-all duration-300 capitalize
                 ${filter === f ? 'bg-white/10 text-white shadow-lg' : 'text-white/40 hover:text-white hover:bg-white/5'}
               `}
             >
               {f}
             </button>
           ))}
        </div>
      </div>

      {/* --- HUD: Timeline Rail --- */}
      <div className="absolute right-8 top-1/2 -translate-y-1/2 h-[400px] w-1 bg-white/5 rounded-full flex flex-col items-center justify-center z-40">
        <div 
          className="w-1.5 h-8 bg-cyan-400 rounded-full shadow-[0_0_15px_#22d3ee] transition-all duration-75 ease-out"
          style={{ 
             transform: `translateY(${visualScroll * 10}px)` // Map scroll to rail
          }} 
        />
      </div>

      {/* --- 3D Viewport --- */}
      <div 
        className="w-full h-full flex items-center justify-center perspective-[1000px] will-change-transform"
        style={{ perspectiveOrigin: '50% 50%' }}
      >
        <div className="relative transform-style-3d w-0 h-0">
          {items.map((item, index) => {
            const effectiveIndex = -item.timeOffset; 
            const style = getCardStyle(effectiveIndex, visualScroll, velocityDisplay);
            const isFocused = Math.round(visualScroll) === effectiveIndex;
            const isFilteredOut = filter !== 'all' && item.type !== filter;
            
            // If filtered out, push it back and fade it
            const finalStyle = isFilteredOut ? {
              ...style,
              opacity: style.opacity * 0.1,
              transform: style.transform + ' translateZ(-200px) scale(0.8)',
              filter: 'blur(4px) grayscale(100%)'
            } : style;

            return (
              <div
                key={item.id}
                className="absolute top-0 left-0 w-[480px] h-[220px] -ml-[240px] -mt-[110px] will-change-transform"
                style={finalStyle}
              >
                <TiltCard 
                  isFocused={isFocused} 
                  onClick={() => {
                     // Animate scroll to this item on click
                     const target = -effectiveIndex;
                     state.current.scroll = visualScroll; // sync
                     const dist = target - visualScroll;
                     state.current.velocity = dist * 0.1; // Push towards target
                     setActiveItem(item);
                  }}
                >
                  <CardContent 
                    item={item} 
                    isFocused={isFocused && !isFilteredOut} 
                    isFilteredOut={isFilteredOut}
                  />
                </TiltCard>
              </div>
            );
          })}
        </div>
      </div>

      {/* --- Overlay (Active Details) --- */}
      {activeItem && (
        <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-md animate-in fade-in duration-300 p-8">
           <div className="w-full max-w-2xl bg-[#0a0a0f] border border-white/10 rounded-2xl shadow-2xl p-8 relative overflow-hidden">
              <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 to-purple-500" />
              <button 
                onClick={() => setActiveItem(null)}
                className="absolute top-4 right-4 p-2 hover:bg-white/10 rounded-full text-white/50 hover:text-white transition-colors"
              >
                <X className="w-6 h-6" />
              </button>
              
              <h2 className="text-2xl font-light text-white mb-2">{activeItem.title}</h2>
              <div className="flex items-center space-x-3 mb-6">
                <span className="text-xs font-mono text-cyan-400 border border-cyan-900/50 bg-cyan-900/20 px-2 py-1 rounded">
                   {activeItem.type.toUpperCase()}
                </span>
                <span className="text-xs text-white/40">{activeItem.timestamp}</span>
              </div>
              
              <p className="text-white/70 leading-relaxed mb-8">
                 {activeItem.details} System logic indicates a 94% probability that this node contains critical path dependencies.
              </p>

              <div className="grid grid-cols-3 gap-4">
                 {[1,2,3].map(i => (
                    <div key={i} className="h-24 bg-white/5 rounded-lg border border-white/5 flex flex-col items-center justify-center">
                       <Activity className="w-5 h-5 text-white/20 mb-2" />
                       <span className="text-[10px] uppercase text-white/30 tracking-widest">Metric 0{i}</span>
                    </div>
                 ))}
              </div>
           </div>
        </div>
      )}

      {/* Vignette & Grain Overlay */}
      <div className="absolute inset-0 pointer-events-none bg-[radial-gradient(circle_at_center,transparent_0%,#050508_110%)]" />
    </div>
  );
};

export default MemorySpiral;
